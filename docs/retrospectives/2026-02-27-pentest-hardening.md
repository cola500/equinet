# Retrospektiv: Pentest-hardening (ZAP-baserat)

**Datum:** 2026-02-27
**Scope:** Penetrationstestning med OWASP ZAP + atgardande av 6 av 9 fynd

---

## Resultat

- 15 andrade filer, 0 nya filer, 0 nya migrationer
- 2577 totala tester (inga regressioner)
- Typecheck = 0 errors, Lint = 0 errors
- Tid: ~1 session

## Vad som byggdes

| Lager | Filer | Beskrivning |
|-------|-------|-------------|
| Config | `next.config.ts` | SRI (`experimental.sri`), hardad CSP (`script-src 'self'` utan `unsafe-inline`), security headers (HSTS, COOP, CORP, COEP, Permissions-Policy) |
| API | `route.ts` (register, feature-flags) | Rate limiting pa register-endpoint, CSRF Origin-validering, error sanitering |
| Infrastructure | `ProviderRepository.ts` | Ta bort verbose error details fran klient-svar |
| Lib | `rate-limit.ts`, `feature-flags.ts`, `feature-flag-definitions.ts` | Nya feature flags for security-features, rate limiter-konfiguration |
| Tester | 4 testfiler | Utokade tester for register, feature-flags, horse profile, providers |
| Docs | `CLAUDE.md`, `NFR.md`, `README.md` | Uppdaterad sakerhetsdokumentation, testantal, key learnings |

## Vad gick bra

### 1. ZAP-driven pentest gav konkreta fynd
Att kora OWASP ZAP (bade baseline och full scan) mot den lokala prod-builden gav 9 konkreta fynd med tydlig severity-gradering. Mycket effektivare an manuell sakerhetsgranskning for att hitta header-problem och CSP-brister.

### 2. SRI som alternativ till nonce-baserad CSP
Att anvanda Next.js experimentella SRI-stod istallet for nonce-baserad CSP var en stor vinst. Nonce kraver dynamisk rendering pa ALLA sidor (stor prestanda-forlust). SRI fungerar med statisk generering och CDN-caching -- en rad i config istallet for en hel proxy-arkitektur.

### 3. Snabb iteration -- 1 fil for storsta sakehetsforbattringen
M2-fixen (CSP hardening) kravde bara andringar i `next.config.ts`. Experimental SRI + borttagen `unsafe-inline` = stor sakerhetsvinst med minimal risk.

### 4. Pentest-rapporten som dokumentation
ZAP-rapporten ger en extern, objektiv baseline for sakerhetsstatusen. Vardefull vid framtida audits och for att visa forbattring over tid.

## Vad kan forbattras

### 1. `style-src 'unsafe-inline'` kvarstar
Tailwind CSS + 23 dynamiska `style={}` i 16 filer gor att vi inte kan ta bort `unsafe-inline` fran `style-src`. Detta ar en kand begransning men bor adresseras langre fram.

**Prioritet:** LAG -- `style-src` ar lagre risk an `script-src`, och Tailwind-ekosystemet har inget bra alternativ idag.

### 2. Ingen automatiserad pentest i CI
ZAP-skanningen kordes manuellt. Idealt borde en baseline-skanning koras automatiskt vid varje deploy eller som nattligt CI-jobb.

**Prioritet:** MEDEL -- NFR-05 (automatiserad sakerhetsskanning) ar redan planerad som P1.

## Patterns att spara

### Next.js SRI for CSP-hardening
`experimental.sri: { algorithm: 'sha256' }` i `next.config.ts` genererar `integrity="sha256-..."` pa alla `<script>`-taggar vid build. Tillater `script-src 'self'` utan `unsafe-inline` i produktion. Webpack-only (prod bygger med webpack, dev anvander Turbopack -- OK). Enkel att ta bort om experimentellt stod bryts.

### Pentest-workflow
1. Bygg prod lokalt (`npm run build && npm start`)
2. Kor ZAP baseline scan mot localhost
3. Kor ZAP full scan (unauthenticated)
4. Kategorisera fynd (H/M/L), filtrera falska positiver
5. Fixa i prioritetsordning (H forst)
6. Verifiera med ny skanning

## Larandeeffekt

**Nyckelinsikt:** SRI ar ett kraftfullt alternativ till nonce-baserad CSP for Next.js-appar med statisk generering. En enda config-rad eliminerar `unsafe-inline` utan att offra prestanda eller CDN-caching. Pentest-verktyg som ZAP ger konkreta, prioriterade fynd som ar mycket effektivare an manuell granskning for header- och CSP-problem.
