# Tech Debt Sprint: Availability Exceptions

> Sprint för att åtgärda tech debt från US-2b implementation.

## Status

| Story | Prioritet | Status |
|-------|-----------|--------|
| TD-1: Unit tests för API endpoints | KRITISK | KLAR |
| TD-2: Extrahera parseDate utility | HÖG | KLAR |
| TD-3: Input sanitization | MEDIUM | **NÄSTA** |
| TD-4: Query param validering | MEDIUM | Planerad |

---

## Stories

### TD-1: Unit Tests för Availability Exceptions API (KRITISK)

**Som** utvecklare
**Vill jag** ha unit tests för alla availability-exceptions endpoints
**Så att** vi uppfyller TDD-principen och kan fånga regressions automatiskt

**Problem:** 0% test coverage för nya endpoints, bryter mot "Coverage >= 80% för API Routes"

**Acceptanskriterier:**
- [ ] Tests för POST /api/providers/[id]/availability-exceptions
  - [ ] Skapa nytt undantag (stängt hela dagen)
  - [ ] Skapa undantag med alternativa tider
  - [ ] Upsert (uppdatera befintligt)
  - [ ] Validering: ogiltigt datumformat
  - [ ] Validering: saknar startTime/endTime när inte stängt
  - [ ] Auth: kräver inloggning
  - [ ] Auth: kräver provider-typ
  - [ ] Auth: kräver ownership
  - [ ] Rate limiting (429 efter för många requests)
- [ ] Tests för GET /api/providers/[id]/availability-exceptions
  - [ ] Lista alla undantag
  - [ ] Filtrera med from/to params
  - [ ] Tom lista om inga undantag
  - [ ] 404 om provider inte finns
- [ ] Tests för GET /api/providers/[id]/availability-exceptions/[date]
  - [ ] Hämta specifikt undantag
  - [ ] 404 om undantag inte finns
  - [ ] 400 om ogiltigt datumformat
- [ ] Tests för DELETE /api/providers/[id]/availability-exceptions/[date]
  - [ ] Ta bort undantag
  - [ ] 404 om undantag inte finns
  - [ ] Auth: kräver ownership
  - [ ] Rate limiting

**Coverage mål:** >= 80%

**Filer att skapa:**
- `src/app/api/providers/[id]/availability-exceptions/route.test.ts`
- `src/app/api/providers/[id]/availability-exceptions/[date]/route.test.ts`

---

### TD-2: Extrahera parseDate till Shared Utility (HÖG)

**Som** utvecklare
**Vill jag** ha en delad parseDate-funktion
**Så att** vi följer DRY-principen och undviker duplicerad kod

**Problem:** Samma funktion finns i två filer

**Acceptanskriterier:**
- [ ] Skapa `src/lib/date-utils.ts` med parseDate-funktion
- [ ] Skapa `src/lib/date-utils.test.ts` med tests
- [ ] Uppdatera båda route-filerna att importera från date-utils
- [ ] Ta bort duplicerad kod
- [ ] Lägg till JSDoc-dokumentation

**Tests för parseDate:**
- [ ] Parsar "2026-01-27" korrekt
- [ ] Hanterar månadsgränser (2026-01-31, 2026-02-01)
- [ ] Hanterar årsskifte (2025-12-31, 2026-01-01)
- [ ] Returnerar lokal tid (inte UTC)

---

### TD-3: Input Sanitization för Reason Field (MEDIUM)

**Som** användare
**Vill jag** inte kunna spara whitespace-only anledningar
**Så att** datan är ren och konsekvent

**Problem:** `reason` field saknar `.trim()` - kan spara "   "

**Acceptanskriterier:**
- [ ] Lägg till `.trim()` på reason i Zod-schema
- [ ] Transform tom sträng efter trim till null
- [ ] Lägg till test för whitespace-only input
- [ ] Lägg till test för normal input med leading/trailing spaces

**Implementation:**
```typescript
reason: z.string()
  .max(200)
  .transform(val => val?.trim() || null)
  .nullable()
  .optional()
```

---

### TD-4: Query Parameter Validering i GET (MEDIUM)

**Som** API-konsument
**Vill jag** få tydliga felmeddelanden vid ogiltiga query params
**Så att** jag kan debugga problem enklare

**Problem:** GET endpoint validerar inte from/to format, kan ge 500 istället för 400

**Acceptanskriterier:**
- [ ] Skapa Zod-schema för query params
- [ ] Validera from/to är YYYY-MM-DD format
- [ ] Returnera 400 med tydligt felmeddelande vid ogiltigt format
- [ ] Lägg till tests för invalid query params

**Implementation:**
```typescript
const querySchema = z.object({
  from: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format").optional(),
  to: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Invalid date format").optional(),
})
```

---

## Sprint Plan

### Sprint 1: Kritisk Tech Debt (TD-1 + TD-2)
**Mål:** Unit tests + DRY refactoring
**Estimat:** 2-3 timmar

1. TD-2 först (15 min) - Extrahera parseDate så testerna kan använda den
2. TD-1 (2-3 tim) - Skriv alla unit tests

### Sprint 2: Polish (TD-3 + TD-4)
**Mål:** Input sanitization + validering
**Estimat:** 30-45 min

1. TD-3 (15 min) - Input sanitization
2. TD-4 (15-30 min) - Query param validering

---

## Definition of Done

En story är DONE när:
- [ ] All kod implementerad
- [ ] Alla acceptanskriterier uppfyllda
- [ ] Tests skrivna och gröna
- [ ] TypeScript inga fel
- [ ] Lint inga fel
- [ ] Manuellt verifierad

---

**Skapad:** 2026-01-27
**Relaterat:** [Retrospektiv](../retrospectives/2026-01-27-calendar-exceptions.md)
