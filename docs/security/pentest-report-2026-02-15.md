# Penetrationstestrapport - Equinet

**Datum**: 2026-02-15
**Testtyp**: Kodgranskning + manuella tester mot lokal instans
**Testad version**: main (commit f38aa40)
**Testare**: Claude Code

---

## Sammanfattning

| Severity | Antal | Fixade | False Positive |
|----------|-------|--------|----------------|
| HIGH | 1 | 1 | 0 |
| MEDIUM | 3 | 3 | 0 |
| LOW | 3 | 0 | 2 |
| INFO | 3 | 0 | 0 |

**Totalt**: 10 fynd, varav 4 fixade, 2 false positives (redan implementerade).

---

## Fixade sarbarheter

### PENTEST-001: XSS i kvitto-HTML (HIGH) -- FIXAD

**Fil**: `src/app/api/bookings/[id]/receipt/route.ts`
**Problem**: `generateReceiptHtml()` anvande template literals utan HTML-escaping. En leverantor med `businessName: "<script>alert(1)</script>"` fick JavaScript att koras i kvittot.
**Fix**: Lade till `escapeHtml()` fran `src/lib/sanitize.ts` pa alla anvandardata (customerName, customerEmail, customerAddress, providerName, businessName, serviceName, serviceDescription, invoiceNumber, startTime, endTime, currency).
**Tester**: 10 nya tester (7 XSS-specifika) i `route.test.ts`.
**Status**: FIXAD

### PENTEST-002: Data-exponering i provider profile (MEDIUM) -- FIXAD

**Fil**: `src/app/api/provider/profile/route.ts`
**Problem**: GET och PUT anvande `include` utan top-level `select`, vilket exponerade alla Provider-falt inklusive `vocabularyTerms` (AI-inlarningsdata).
**Fix**: Bytte till explicit `select` pa Provider-modellen i bade GET och PUT. `vocabularyTerms`, `verifiedBy`, och andra interna falt exponeras inte langre.
**Tester**: 2 nya tester (select-kontroll + non-provider 401).
**Status**: FIXAD

### PENTEST-003: Route order GET saknar select pa routeStops (MEDIUM) -- FIXAD

**Fil**: `src/app/api/route-orders/[id]/route.ts`
**Problem**: `routeStops` returnerades utan `select`, vilket exponerade alla falt inklusive `problemNote`, `actualArrival`, `actualDeparture`.
**Fix**: Lade till `select` som begransar till: id, stopOrder, locationName, address, latitude, longitude, estimatedArrival, estimatedDurationMin, status.
**Tester**: 2 nya tester.
**Status**: FIXAD

---

## Oppna fynd

### PENTEST-004: Login rate limiting per e-post, inte per IP (MEDIUM) -- FIXAD

**Kategori**: Auth
**Fil**: `src/app/api/auth/[...nextauth]/route.ts`, `src/lib/rate-limit.ts`
**Problem**: Login rate limiting anvande enbart e-postadress som identifier. En angripare kunde utfora password spraying (testa samma losenord mot tusentals e-postadresser) utan att nagon per-IP rate limiting slog in.
**Fix**: La till IP-baserad rate limiting (`loginIp`: 30 forsok/15 min i prod, 200/15 min i dev) som wrapper runt NextAuth POST-handler. Wrappern checkar IP FORE requesten nar `authorize()` i NextAuth. E-postbaserad rate limiting (10/15 min) behovs kvar for att skydda enskilda konton.
**Tester**: 6 nya tester i `route.test.ts` (429 vid limit, passthrough inom limit, IP-extrahering, ingen rate limiting pa icke-credentials paths).
**Status**: FIXAD

### PENTEST-005: Saknade security headers (LOW)

**Kategori**: Config
**Problem**: `curl -sI http://localhost:3000` visade inga security headers (CSP, X-Frame-Options, HSTS, Permissions-Policy).
**Notering**: Kan vara Next.js dev-mode som inte inkluderar headers. Verifiera i produktionsmiljon.
**Atgard**: Lagg till i `next.config.ts` eller middleware:

```typescript
// next.config.ts
headers: async () => [{
  source: '/(.*)',
  headers: [
    { key: 'X-Frame-Options', value: 'DENY' },
    { key: 'X-Content-Type-Options', value: 'nosniff' },
    { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
    { key: 'Permissions-Policy', value: 'camera=(), microphone=(self), geolocation=()' },
  ],
}],
```

### PENTEST-006: Ingen validering av bokningsdatum i framtiden (LOW) -- FALSE POSITIVE

**Kategori**: Business Logic
**Fil**: `src/domain/booking/BookingService.ts`
**Ursprungligt pastaende**: `createBooking()` validerar inte att `bookingDate` ar i framtiden.
**Verifiering**: TimeSlot value object (`src/domain/booking/value-objects/TimeSlot.ts`) validerar redan start/sluttider. `INVALID_TIMES` error type hanteras i BookingService (rad 242, 457) och mappas till HTTP 400. Tester bekraftar detta (`BookingService.test.ts:156, 170`).
**Status**: FALSE POSITIVE -- redan implementerat

### PENTEST-007: Recensioner for icke-avklarade bokningar (LOW) -- FALSE POSITIVE

**Kategori**: Business Logic
**Ursprungligt pastaende**: Det finns ingen kontroll av `booking.status === 'completed'` vid skapande av kundrecensioner.
**Verifiering**: `ReviewService.ts:97` checkar `booking.status !== 'completed'` och returnerar `BOOKING_NOT_COMPLETED` error. Route mappar till HTTP 400 (`customer-reviews/route.ts:21`). Tester bekraftar (`ReviewService.test.ts:102`, `route.test.ts:252`).
**Status**: FALSE POSITIVE -- redan implementerat

---

## Informativa fynd (ingen sarbarhet)

### INFO-001: In-memory rate limiting i dev har hogt tak

In-memory fallback har medvetet hoga granser (login: 50, registration: 50, API: 1000) for att inte blockera E2E-tester. Produktion anvander Upstash Redis med korrekta granser (login: 10, registration: 3, API: 100).

### INFO-002: acceptingNewCustomers bypass i createManualBooking

`createManualBooking()` checkar INTE `acceptingNewCustomers`. Detta ar **by design** -- nar en leverantor manuellt skapar en bokning overrider de sin egen installning.

### INFO-003: Reset-rate-limit endpoint i produktion

`/api/test/reset-rate-limit` har korrekt `NODE_ENV === 'production'`-guard som returnerar 404.

---

## Testresultat per fas

### Fas 2: Autentisering

| # | Test | Resultat | Kommentar |
|---|------|----------|-----------|
| 2.1 | Brute force login | WARN | Rate limiting per e-post (50/15min dev), ej per IP |
| 2.2 | Cookie-flaggor | N/A | Inga cookies synliga via curl (NextAuth hanterar internt) |
| 2.4 | Losenordspolicy | PASS | Krav: 8 tecken, versaler, siffror, specialtecken, zxcvbn |
| 2.5 | Kontoenumeration | PASS | Identiska felmeddelanden ("Bad request.") |
| 2.7 | Registrerings-rate limit | PASS | Rate limiting slar in |

### Fas 3: Auktorisering & IDOR

| # | Test | Resultat | Kommentar |
|---|------|----------|-----------|
| 3.4 | Kund -> admin-endpoints | PASS | 401 utan auth |
| 3.5 | Kund -> leverantors-endpoints | PASS | Rollkontroll i auth |
| 3.9 | Cron utan secret | PASS | 401 utan token, 401 med falsk token |
| 3.10 | Reset-rate-limit prod | PASS | NODE_ENV-guard finns |

### Fas 4: Input-validering & Injection

| # | Test | Resultat | Kommentar |
|---|------|----------|-----------|
| 4.1 | JSON field injection | PASS | Avvisat (Zod .strict()) |
| 4.2 | Type confusion | PASS | Avvisat ("Bad request.") |
| 4.5 | SQL injection | PASS | Prisma parametriserar queries |
| 4.6 | Stor payload | PASS | 400 returneras |

### Fas 5: Affarslogik

| # | Test | Resultat | Kommentar |
|---|------|----------|-----------|
| 5.2 | Dubbelbokning | PASS | Atomisk $transaction med Serializable isolation |
| 5.3 | Ogiltiga statusovergangar | PASS | State machine (BookingStatus value object) |
| 5.4 | Kund markerar som klar | PASS | PROVIDER_ONLY_STATUSES blockerar |
| 5.6 | Bypass acceptingNewCustomers | PASS | Separat kod for manuell bokning (by design) |

### Fas 7: CORS & Konfiguration

| # | Test | Resultat | Kommentar |
|---|------|----------|-----------|
| 7.1 | CORS | PASS | Inga CORS-headers for evil.com |
| 7.2 | Informationslackage | PASS | Generiska felmeddelanden, inga stack traces |

---

## Sammanfattning av sakerhetsstatus

**Styrkor**:
- Solid Zod-validering med `.strict()` pa alla endpoints
- Prisma forhindrar SQL injection
- State machine for bokningsstatusovergangar
- Atomisk overlap-check med Serializable transaction
- Korrekt IDOR-skydd via WHERE-klausuler med session-data
- Rollbaserad atkomstkontroll (customer/provider/admin)
- Rate limiting pa alla kritiska endpoints (med Upstash i prod)
- LLM-output Zod-valideras (voice logging)
- NODE_ENV-guard pa test-endpoints

**Kvarstaende**:
- PENTEST-005: Security headers i produktion (LOW) -- verifiera i produktionsmiljon

---

*Rapport genererad: 2026-02-15*
