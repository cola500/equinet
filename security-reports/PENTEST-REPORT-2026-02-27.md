# Penetrationstest-rapport: Equinet

**Datum:** 2026-02-27
**Testare:** Claude Code (OWASP ZAP + manuella tester)
**Miljo:** Lokal utvecklingsmiljo (localhost:3000, PostgreSQL Docker)
**Verktyg:** OWASP ZAP 2.17.0 (Docker), Playwright, curl

---

## Sammanfattning

Equinet har en **stark sakerhetsniva** for en MVP. Inga kritiska sarbarheter hittades. Autentisering, auktorisering och input-validering fungerar konsekvent val. De flesta fynd ar hardening-atgarder (medium/lag allvarlighet) som bor fixas fore produktionsrelease.

**Resultat:** 0 kritiska, 1 hog, 4 medium, 4 laga

---

## Testomfattning

| Omrade | Metod | Resultat |
|--------|-------|----------|
| Headers & cookies | ZAP Baseline Scan | 5 varningar, 0 failures |
| IDOR (Insecure Direct Object Reference) | Manuellt (7 tester) | PASS -- alla blockerade |
| Privilege Escalation | Manuellt (4 tester) | PASS -- korrekt rollkontroll |
| Rate Limiting (login) | Manuellt (8 forsok) | ANMARKNING -- dev-lage har for hogt limit |
| Email Enumeration | Manuellt (4 tester) | FAIL -- registrering avsloja |
| Prompt Injection (AI) | Manuellt (2 tester) | PASS -- AI ignorerar injection |
| SQL Injection | Manuellt (2 tester) | PASS -- Prisma parametriserar |
| XSS | Manuellt + ZAP | PASS -- React + Prisma escape |
| Filexponering (.git, .env) | Manuellt (3 tester) | PASS -- 404 |
| Security Headers | ZAP + manuellt | ANMARKNING -- se detaljer |
| Cron-endpoints | Manuellt (2 tester) | PASS -- 401 utan auth |
| Feature Flags (publikt) | Manuellt | ANMARKNING -- information disclosure |
| Hardkodade secrets | Git grep | PASS -- inga hittade |

---

## Fynd

### HOG ALLVARLIGHET

#### H1: Email Enumeration via registrerings-endpoint

**Endpoint:** `POST /api/auth/register`
**Beskrivning:** Registrerings-API:et returnerar olika svar beroende pa om email redan finns:
- Befintlig email: `400 "En anvandare med denna email finns redan"`
- Ny email: `201 "Anvandare skapad"`

**Risk:** En angripare kan masstesta emails for att kartlagga vilka som har konton. Detta kan anvandas for riktade phishing-attacker.

**Jamforelse:** `POST /api/auth/forgot-password` hanterar detta KORREKT -- samma svar oavsett om email finns.

**Rekommendation:**
```typescript
// Istallet for explicit "finns redan"-fel:
// 1. Returnera alltid 200 med generiskt meddelande
// 2. Skicka email till befintlig anvandare: "Nagon forsoke registrera med din email"
// 3. Returnera ALDRIG user-objekt i response vid lyckad registrering
return NextResponse.json({
  message: "Om registreringen lyckades har vi skickat en verifieringslankar till din email."
}, { status: 200 })
```

**Bonus-fynd:** Lyckad registrering returnerar user-objekt med `id` och `email` -- bor tas bort.

---

### MEDIUM ALLVARLIGHET

#### M1: X-Powered-By header avslöjar serverinfo

**Header:** `X-Powered-By: Next.js`
**Risk:** Ger angripare information om vilken teknologi som anvands, vilket gor det lattare att hitta kanda sarbarheter.

**Fix:**
```typescript
// next.config.ts
const nextConfig = {
  poweredByHeader: false,
  // ...
}
```

#### M2: CSP innehaller `unsafe-inline` och `unsafe-eval`

**Nuvarande CSP:**
```
script-src 'self' 'unsafe-eval' 'unsafe-inline'
style-src 'self' 'unsafe-inline'
```

**Risk:** `unsafe-inline` och `unsafe-eval` forsvagar CSP:ns skydd mot XSS avsevart. Aven om React ger grundskydd ar detta en forsvagning.

**Rekommendation:** Anvand nonce-baserad CSP:
```
script-src 'self' 'nonce-{random}'
style-src 'self' 'nonce-{random}'
```

**Notering:** Next.js kraver `unsafe-eval` i dev-lage. Satt striktare CSP i produktion.

#### M3: Publikt feature-flags endpoint avslöjar intern konfiguration

**Endpoint:** `GET /api/feature-flags`
**Returnerar:** Alla feature flags med deras status (true/false)

**Risk:** Avslöjar vilka features som ar under utveckling, vilka som ar avstangda, och kan ge angripare en karta over funktionalitet att undersöka.

**Rekommendation:**
1. Returnera BARA flaggor som ar relevanta for klienten
2. Filtrera bort interna/admin-flaggor
3. Overvag att lasa via server-side rendering istallet for publikt API

#### M4: Provider-API avslöjar userId

**Endpoint:** `GET /api/providers`
**Returnerar:** `userId` i varje provider-objekt

**Risk:** `userId` ar en intern identifierare som inte behövs i publika svar. Kan anvandas for IDOR-forsok mot andra endpoints.

**Fix:** Ta bort `userId` fran `select`-blocket i provider-queryn.

---

### LAG ALLVARLIGHET

#### L1: Cross-Origin-Embedder-Policy saknas

**Header:** `Cross-Origin-Embedder-Policy` ar inte satt.
**Risk:** Lag -- paverkar bara cross-origin isolation for SharedArrayBuffer etc.
**Fix:** Lagg till `Cross-Origin-Embedder-Policy: require-corp` om cross-origin isolation onskasundefined (kan kranga med externa resurser).

#### L2: Timestamp Disclosure i JS-bundles

**Hittad i:** `_next/static/chunks/node_modules_*.js`
**Risk:** Minimal -- Unix-timestamps i bundlade node_modules avslöjar inget anvanbart.
**Atgard:** Ingen atgard nödvandig (falsk positiv fran ZAP).

#### L3: Dangerous JS Functions (eval) i Turbopack

**Hittad i:** `turbopack-*.js`
**Risk:** Minimal -- detta ar Next.js dev-server, inte produktionskod.
**Atgard:** Ingen -- forsvinner i production build.

#### L4: Dev-lage rate limits ar for höga

**Konfiguration:** In-memory fallback satter login-limit till 50 forsok/15 min (prod: 10).
**Risk:** Lag -- paverkar bara lokal utveckling. Upstash i prod har korrekt limit.
**Rekommendation:** Sank dev-limits till narmre prod-varden (t.ex. 15) for att fanga rate-limit-buggar under utveckling.

---

## Positiva fynd (saker som fungerar bra)

| Omrade | Status | Detalj |
|--------|--------|--------|
| HttpOnly cookies | PASS | Session-cookies kan inte lasas av JavaScript |
| SameSite=strict | PASS | CSRF-skydd via cookie-attribut |
| Auth middleware | PASS | Skyddade routes blockeras korrekt for oautentiserade |
| Rollbaserad atkomst | PASS | Customer kan inte na provider/admin-routes |
| IDOR-skydd | PASS | customerId/providerId hamtas fran session, inte request |
| Zod .strict() | PASS | Okanda falt i request body avvisas |
| SQL Injection-skydd | PASS | Prisma parametriserar alla queries |
| XSS-skydd | PASS | React DOM-escaping + ingen dangerouslySetInnerHTML hittad |
| AI Prompt Injection-skydd | PASS | Strukturerad output med confidence=0 vid injection |
| Filexponering | PASS | .git, .env, source maps inte atkomliga |
| Cron-endpoints | PASS | Kraver autentisering |
| Forgot password | PASS | Samma svar oavsett om email finns |
| Git history | PASS | Inga secrets committade |
| Security headers | MESTADELS PASS | X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy alla korrekta |
| Lösenordskrav | PASS | Stark lösenordspolicy (8+ tecken, versal, gemen, siffra, specialtecken) |

---

## Prioriterad atgardslista

| Prio | Fynd | Uppskattad insats | Fil att ändra |
|------|------|-------------------|---------------|
| 1 | H1: Email enumeration | 30 min | `src/app/api/auth/register/route.ts` |
| 2 | M1: X-Powered-By | 2 min | `next.config.ts` |
| 3 | M4: userId i provider-API | 10 min | `src/app/api/providers/route.ts` |
| 4 | M3: Feature flags filtrering | 30 min | `src/app/api/feature-flags/route.ts` |
| 5 | M2: CSP hardening | 1-2 timmar | `src/middleware.ts` |
| 6 | L4: Dev rate limits | 5 min | `src/lib/rate-limit.ts` |

---

## Tester som INTE utfordes (utanfor scope)

- ZAP Full Scan (oautentiserad) -- avbruten efter 20 min, tar 60+ min
- ZAP Autentiserad Scan (Fas 4) -- kraver manuell token-konfiguration
- Filuppladdning -- ingen testfil laddades upp
- Production baseline scan -- utfors separat
- DDoS/stress-testning
- Penetrationstest av tredjepartstjanster (Supabase, Anthropic)

---

## Rekommenderade uppföljningar

1. **Kor ZAP full scan i CI** -- automatisera som nattlig korning
2. **Implementera audit logging** -- admin-panelen saknar loggar over ândringar
3. **Overvag 2FA for admin** -- admin-konton har hogre privilegier
4. **Content scanning for filuppladdning** -- verifiera MIME-typ, scanna for malware
5. **CORS-konfiguration** -- verifiera att `Access-Control-Allow-Origin` ar restriktivt i prod
6. **Production baseline scan** -- kor efter deploy for att verifiera headers i prod
