// Equinet - Booking platform for horse service providers
// Database schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  userType      String    // 'provider' eller 'customer'
  firstName     String
  lastName      String
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  provider      Provider?
  bookings      Booking[]
  notifications Notification[]
  routeOrders   RouteOrder[]
}

model Provider {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName    String
  description     String?
  address         String?
  city            String?
  postalCode      String?
  serviceArea     String?   // JSON array av områden
  profileImageUrl String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  services        Service[]
  availability    Availability[]
  bookings        Booking[]
  routes          Route[]
}

model Service {
  id              String   @id @default(uuid())
  providerId      String
  provider        Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  price           Float
  durationMinutes Int
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  bookings        Booking[]
}

model Availability {
  id          String   @id @default(uuid())
  providerId  String
  provider    Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  dayOfWeek   Int      // 0-6 (0=Måndag, 6=Söndag)
  startTime   String   // Format: "09:00"
  endTime     String   // Format: "17:00"
  isClosed    Boolean  @default(false) // true = Stängt hela dagen
  isActive    Boolean  @default(true)  // false = Raderad/inaktiv
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([providerId, dayOfWeek])
}

model Booking {
  id            String   @id @default(uuid())
  customerId    String
  customer      User     @relation(fields: [customerId], references: [id])
  providerId    String
  provider      Provider @relation(fields: [providerId], references: [id])
  serviceId     String
  service       Service  @relation(fields: [serviceId], references: [id])
  bookingDate   DateTime
  startTime     String
  endTime       String
  status        String   @default("pending") // pending, confirmed, cancelled, completed
  customerNotes String?
  horseName     String?
  horseInfo     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// Route-based delivery models
model RouteOrder {
  id                   String      @id @default(uuid())
  customerId           String
  customer             User        @relation(fields: [customerId], references: [id])
  serviceType          String      // t.ex. 'hovslagning', 'massage'
  address              String
  latitude             Float
  longitude            Float
  numberOfHorses       Int         @default(1)
  dateFrom             DateTime
  dateTo               DateTime
  priority             String      @default("normal") // 'normal' eller 'urgent'
  specialInstructions  String?
  contactPhone         String
  status               String      @default("pending") // 'pending', 'in_route', 'completed', 'cancelled'
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  routeStops           RouteStop[]
}

model Route {
  id                   String      @id @default(uuid())
  providerId           String
  provider             Provider    @relation(fields: [providerId], references: [id])
  routeName            String
  routeDate            DateTime
  startTime            String      // Format: "08:00"
  status               String      @default("planned") // 'planned', 'active', 'completed', 'cancelled'
  totalDistanceKm      Float?
  totalDurationMinutes Int?
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  stops                RouteStop[]
}

model RouteStop {
  id                     String      @id @default(uuid())
  routeId                String
  route                  Route       @relation(fields: [routeId], references: [id], onDelete: Cascade)
  routeOrderId           String
  routeOrder             RouteOrder  @relation(fields: [routeOrderId], references: [id])
  stopOrder              Int         // 1, 2, 3... ordning i rutten
  estimatedArrival       DateTime?
  estimatedDurationMin   Int         @default(60) // Beräknad tid på plats
  actualArrival          DateTime?
  actualDeparture        DateTime?
  status                 String      @default("pending") // 'pending', 'in_progress', 'completed', 'problem'
  problemNote            String?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt
}
