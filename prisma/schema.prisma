// Equinet - Booking platform for horse service providers
// Database schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  userType     String // 'provider' eller 'customer'
  firstName    String
  lastName     String
  phone        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  provider      Provider?
  bookings      Booking[]
  notifications Notification[]
  routeOrders   RouteOrder[]
}

model Provider {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName    String
  description     String?
  address         String?
  city            String?
  postalCode      String?

  // NEW: Geographic coordinates (geocoded from address)
  latitude        Float?
  longitude       Float?
  serviceAreaKm   Float?   @default(50) // Max service radius in km

  serviceArea     String? // DEPRECATED: JSON array av områden (keep for backward compatibility)
  profileImageUrl String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  services     Service[]
  availability Availability[]
  bookings     Booking[]
  routes       Route[]
  routeOrders  RouteOrder[] // NEW: Provider-announced route orders

  @@index([isActive, createdAt])
  @@index([city])
  @@index([businessName])
  @@index([latitude, longitude]) // NEW: For geo-queries
}

model Service {
  id              String   @id @default(uuid())
  providerId      String
  provider        Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  name            String
  description     String?
  price           Float
  durationMinutes Int
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())

  bookings Booking[]

  @@index([providerId, isActive])
}

model Availability {
  id         String   @id @default(uuid())
  providerId String
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  dayOfWeek  Int // 0-6 (0=Måndag, 6=Söndag)
  startTime  String // Format: "09:00"
  endTime    String // Format: "17:00"
  isClosed   Boolean  @default(false) // true = Stängt hela dagen
  isActive   Boolean  @default(true) // false = Raderad/inaktiv
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([providerId, dayOfWeek])
}

model Booking {
  id            String      @id @default(uuid())
  customerId    String
  customer      User        @relation(fields: [customerId], references: [id])
  providerId    String
  provider      Provider    @relation(fields: [providerId], references: [id])
  serviceId     String
  service       Service     @relation(fields: [serviceId], references: [id])
  routeOrderId  String?
  routeOrder    RouteOrder? @relation(fields: [routeOrderId], references: [id])
  bookingDate   DateTime
  startTime     String
  endTime       String
  status        String      @default("pending") // pending, confirmed, cancelled, completed
  customerNotes String?
  horseName     String?
  horseInfo     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([providerId, bookingDate, status])
  @@index([customerId, bookingDate])
  @@index([serviceId])
  @@index([routeOrderId])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

// Route-based delivery models
model RouteOrder {
  id                  String   @id @default(uuid())

  // Customer-initiated fields (nullable when provider-announced)
  customerId          String?
  customer            User?    @relation(fields: [customerId], references: [id])

  // NEW: Provider-announced fields
  providerId          String?
  provider            Provider? @relation(fields: [providerId], references: [id])
  announcementType    String   @default("customer_initiated") // 'customer_initiated' | 'provider_announced'

  // Shared fields (used by both flows)
  serviceType         String // t.ex. 'hovslagning', 'massage'
  address             String
  latitude            Float?   // Optional - geocoding not required for MVP
  longitude           Float?   // Optional - geocoding not required for MVP
  numberOfHorses      Int      @default(1)
  dateFrom            DateTime
  dateTo              DateTime
  priority            String   @default("normal") // 'normal' eller 'urgent'
  specialInstructions String?
  contactPhone        String?  // Optional - not needed for provider announcements
  status              String   @default("pending") // 'pending', 'in_route', 'completed', 'cancelled'
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  routeStops RouteStop[]
  bookings   Booking[]

  @@index([status, serviceType])
  @@index([status, priority])
  @@index([customerId, status])
  @@index([dateFrom, dateTo, status])
  @@index([providerId, announcementType, status]) // NEW: Provider announcements
  @@index([latitude, longitude, announcementType]) // NEW: Geo-search
}

model Route {
  id                   String   @id @default(uuid())
  providerId           String
  provider             Provider @relation(fields: [providerId], references: [id])
  routeName            String
  routeDate            DateTime
  startTime            String // Format: "08:00"
  status               String   @default("planned") // 'planned', 'active', 'completed', 'cancelled'
  totalDistanceKm      Float?
  totalDurationMinutes Int?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  stops RouteStop[]

  @@index([providerId, routeDate, status])
  @@index([status])
}

model RouteStop {
  id                   String     @id @default(uuid())
  routeId              String?    // Optional - announcements don't have Route
  route                Route?     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  routeOrderId         String
  routeOrder           RouteOrder @relation(fields: [routeOrderId], references: [id])
  stopOrder            Int // 1, 2, 3... ordning i rutten
  locationName         String?    // NEW: "Alingsås centrum", "Sollebrunn" (för provider announcements)
  address              String     // NEW: Full address for the stop
  latitude             Float?     // NEW: Optional - geocoding not required for MVP
  longitude            Float?     // NEW: Optional - geocoding not required for MVP
  estimatedArrival     DateTime?
  estimatedDurationMin Int        @default(60) // Beräknad tid på plats
  actualArrival        DateTime?
  actualDeparture      DateTime?
  status               String     @default("pending") // 'pending', 'in_progress', 'completed', 'problem'
  problemNote          String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt

  @@index([routeId, stopOrder])
  @@index([routeOrderId])
  @@index([status])
}
